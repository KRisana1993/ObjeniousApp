<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Go Project</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
		<link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="/static/css/style.css">
		
		<script type="text/javascript">
			let token = null;
			let deviceList = null;
			let csvFile = null;
			$(document).ready(function() {
				$("#callGo").on('click', function() {
					$("#tenantList").removeClass("hidden");
					loginInfo = {
						"login": "rkamalakaran.ext@objenious.com",
						"password": "Michael1508"
					}
					$.ajax({
						url: "https://api-preprod.objenious.com/v2/login",
						contentType: 'application/json',
                        method: "POST",
						data: JSON.stringify(loginInfo),
						success: function(data) {
							token = data.token;
							$.ajax({
								url: "http://api-preprod.objenious.com/v2/user/profile",
								method: "GET",
								headers: {
									"x-token": data.token
								},
								success: function(tenantList) {
									tenantList.contexts.forEach(element => {
										$("#tenantList")
											.append($("<option></option>")
                							.attr("value",element.id)
                							.text(element.organization_label));
									});
								},
							})
						},
					});
				});
			});
			function tenantListSelect (index, choosenTenant) {
				var paragraph = document.getElementById("choosenTenant");
				var text = document.createTextNode(choosenTenant);
				paragraph.appendChild(text);

				$.ajax({
					url: "https://api-preprod.objenious.com/v2/user/profile/chooseContext/" + index,
					method: "POST",
					headers: {
						"x-token": token
					},
					success: function(tenant) {
						$.ajax({
							url: "https://api-preprod.objenious.com/v2/devices",
							method: "GET",
							headers: {
								"x-token": token
							},
							success: function (tenantDevices) {
								deviceList = tenantDevices;
								var table = $('#tenantDevice');
								table.find("thead tr")[0].style.visibility = "visible";
								table.find("tbody tr").remove();
								var header = table.find("thead tr#tableHeader")
								header.append("<th>ID</th><th>Name</th><th>Description</th>")
								var propertiesKeys = [];
								tenantDevices.forEach(function (elt) {
									Object.keys(elt.properties).forEach(function (head) {
										propertiesKeys.push(head);
									})
								});
								var unique = propertiesKeys.filter(function(elem, index, self) {
									return index === self.indexOf(elem);
								})
								unique.forEach(function(tablehead) {
									header.append("<th>" + tablehead + "</th>")
								})
								tenantDevices.forEach(function (elt2) {
									table.append("<tr id='" + elt2.id + "'><td>" + elt2.id + "</td><td>" + elt2.name + "</td><td>" + elt2.description + "</td></tr>");
									unique.forEach(function (key) {
										var row = document.getElementById(elt2.id);
										var x = row.insertCell(-1);
										x.innerHTML= "<td>" + elt2.properties[key] + "</td>";
									})
								})
							}
						})
					},
				})
			}
			function handleFileSelect(evt) {
				var file = evt.target.files[0];
				Papa.parse(file, {
					header: true,
					dynamicTyping: true,
					complete: function(results) {
						data = results;
						csvFile = data.data;
						createSendingElement();
						var table = $('#CSVfileContent');
						table.find("thead tr")[0].style.visibility = "visible";
						table.find("tbody tr").remove();
						var header = table.find("thead tr#tableCSVHeader")
						
						var propertiesKeys = [];
						csvFile.forEach(function (elt) {
							Object.keys(elt).forEach(function (head) {
								propertiesKeys.push(head);
							})
						});
						var unique = propertiesKeys.filter(function(elem, index, self) {
							return index === self.indexOf(elem);
						})
						
						var p = $('#csvFileContent');
						p[0].style.visibility = "visible";

						unique.forEach(function (key) {
							header.append("<th>" + key + "</th>")
						})

						csvFile.forEach(function (elt2) {
							table.append("<tr id='csv" + elt2.id + "'></tr>");
							unique.forEach(function (key) {
								var row = document.getElementById('csv' + elt2.id);
								var x = row.insertCell(-1);
								x.innerHTML= "<td>" + elt2[key] + "</td>";
							})
						})
					}
				});
		    }
			var eltIdentique = [];
			var tab = []
			$(document).ready(function(){
				$("#csv-file").change(handleFileSelect);
			});
			function createSendingElement() {

				csvFile.forEach(function (elt) {
					deviceList.forEach(function (elt2) {
						if(elt.id === elt2.id) {
							eltIdentique.push(elt.id);
							console.log('EXISTE');
						}
					})
				})
			
				eltIdentique.forEach(function (ids) {
					csvFile.forEach(function (csv) {
						if(ids === csv['id']) {
							var result = deviceList.find(obj => {
								return obj.id === ids
							})
							var sendingObject = {
								"group_id" : result.group.id,
								'profile_id' : result.profile.id,
								"properties" : {}
							};
							if ((keyExist = "name" in csv) === true) {
								sendingObject.name = csv.name;
							}
							if ((keyExist = "description" in csv) === true) {
								sendingObject.description = csv.description;
							}
							if ((keyExist = "status" in csv) === true) {
								sendingObject.status = csv.status;
							}
							
							sendingObject.properties = csv;
							sendingObject.properties.external_id = result.properties.external_id
							tab.push(sendingObject);
						}
					})
				})
				/* $('#existElt').append("L'ID suivant existe dans les deux listes : " + elt.id + "</br>");
					var sendingElt ={
						"name": elt2.name,
						"group_id": elt.group.id,
						"profile_id": elt.profile.id,
						"properties": {
							"external_id": elt.properties.external_id
						}
					}
					console.log('sending element : ', sendingElt);
					$.ajax({
						url: "https://api-preprod.objenious.com/v2/devices/" + elt.id,
						method: "PUT",
						headers: {
							"x-token": token,
						},
						data: JSON.stringify(sendingElt),
					}) */
				// console.log('taille du device list : ', deviceList.length)
				// console.log('IDENTIQUE = ', identique);

				updateFunction ();
			}

			function updateFunction () {
				/* tab.forEach(function(elt) {
					delete elt.properties.name
					delete elt.properties.id
					delete elt.properties.description
					delete elt.properties.status
				}) */
				console.log('UPDATE', tab, eltIdentique);
			}
		</script>
	</head>
 
	<body>
		<div class="header"></div>
		<div class="sidenav">
			<a>Cross Tenant</a>
		</div>
		</br></br></br></br></br></br>
		<div id="myModal" style="visibility: hidden;">
			<div class="modal-dialog modal-confirm">
				<div class="modal-content">
					<div class="modal-header">
						<div class="icon-box">
							<i class="material-icons">&#xE876;</i>
						</div>				
						<h4 class="modal-title">Succès !</h4>	
					</div>
					<div class="modal-body">
						<p class="text-center">Vos modifications ont bien été prise en compte</p>
					</div>
					<div class="modal-footer">
						<button id="successBtn" class="btn-error btn-success btn-block" data-dismiss="modal">OK</button>
					</div>
				</div>
			</div>
		</div>
		<div id="crossTenantPart">
			<button id="callGo" type="submit">Connexion à l'API</button>
			<select id="tenantList" onchange="tenantListSelect(this.options[selectedIndex].value, this.options[selectedIndex].text)"></select>
			<input type="file" id="csv-file" name="files"/>
			</br></br>
			<p style="font-weight: bold;" id="choosenTenant"></p>
			<table id="tenantDevice">
				<thead>
					<tr id="tableHeader" style="visibility: hidden;"></tr>
				</thead>
			</table>
			</br>
			<p style="font-weight: bold; visibility: hidden;" id="csvFileContent">Contenu du fichier CSV</p>
			<table id="CSVfileContent">
				<thead>
					<tr id="tableCSVHeader" style="visibility: hidden;">
					</tr>
				</thead>
			</table>
			<p id="existElt"></p>
		</div>
	</body>
</html>